<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/admin-layout :: admin-layout(pageTitle='Predicci贸n de Ventas', content=~{::.prediccion-content})}">

<body>
<div class="prediccion-content">

    <div class="row" th:if="${resultado.mejorPeriodo != null}">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Ingresos Totales (Periodo)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${#numbers.formatCurrency(resultado.ingresosTotales)}"></div>
                        </div>
                        <div class="col-auto"><i class="fas fa-dollar-sign fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Venta Promedio (por Periodo)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${#numbers.formatCurrency(resultado.ventaPromedio)}"></div>
                        </div>
                        <div class="col-auto"><i class="fas fa-balance-scale fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Items Vendidos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${resultado.totalItems}"></div>
                        </div>
                        <div class="col-auto"><i class="fas fa-box-open fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Mejor Periodo</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${#temporals.format(resultado.mejorPeriodo.fecha, 'yyyy-MM-dd')}"></div>
                            <small th:text="|con ${#numbers.formatCurrency(resultado.mejorPeriodo.totalVendido)}|"></small>
                        </div>
                        <div class="col-auto"><i class="fas fa-trophy fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card shadow mb-4">
        <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Filtros de An谩lisis</h6></div>
        <div class="card-body">
            <form th:action="@{/prediccion}" method="get" id="filtroForm">
                <input type="hidden" name="granularidad" id="granularidad" th:value="${granularidadActual}">
                <div class="row">
                    <div class="col-md-9">
                        <div class="form-row align-items-end">
                            <div class="form-group col-md-4">
                                <label for="fechaInicio">Desde:</label>
                                <input type="date" class="form-control" id="fechaInicio" name="fechaInicio" th:value="${fechaInicio}">
                            </div>
                            <div class="form-group col-md-4">
                                <label for="fechaFin">Hasta:</label>
                                <input type="date" class="form-control" id="fechaFin" name="fechaFin" th:value="${fechaFin}">
                            </div>
                            <div class="form-group col-md-4">
                                <label for="productoId">Producto:</label>
                                <select class="form-control" id="productoId" name="productoId" onchange="this.form.submit()">
                                    <option value="">-- Todos los Productos --</option>
                                    <option th:each="prod : ${productos}"
                                            th:value="${prod.id}"
                                            th:text="${prod.nombre}"
                                            th:selected="${prod.id == productoIdSeleccionado}"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 d-flex align-items-end justify-content-between">
                         <div class="btn-group btn-group-toggle" data-toggle="buttons">
                            <label class="btn btn-outline-secondary" th:classappend="${granularidadActual == 'DIARIA' ? 'active' : ''}"><input type="radio" name="granularidad_radio" onclick="setGranularidad('DIARIA')"> Diario</label>
                            <label class="btn btn-outline-secondary" th:classappend="${granularidadActual == 'SEMANAL' ? 'active' : ''}"><input type="radio" name="granularidad_radio" onclick="setGranularidad('SEMANAL')"> Semanal</label>
                            <label class="btn btn-outline-secondary" th:classappend="${granularidadActual == 'MENSUAL' ? 'active' : ''}"><input type="radio" name="granularidad_radio" onclick="setGranularidad('MENSUAL')"> Mensual</label>
                        </div>
                        <button type="submit" class="btn btn-primary ml-3"><i class="fas fa-filter"></i></button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary" th:text="| Gr谩fico de Proyecci贸n (${granularidadActual})|">Gr谩fico</h6>
            <a th:href="@{/prediccion/exportar-excel(fechaInicio=${fechaInicio}, fechaFin=${fechaFin}, granularidad=${granularidadActual}, productoId=${productoIdSeleccionado})}" class="btn btn-success btn-sm">
                <i class="fas fa-file-excel"></i> Exportar
            </a>
        </div>
        <div class="card-body">
            <div class="chart-container" style="position: relative; height:40vh; width:100%;"><canvas id="ventasChart"></canvas></div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const resultado = /*[[${resultado}]]*/ {};
        const periodos = resultado.periodos || [];
        const pred1 = resultado.prediccion1 || 0;
        const pred2 = resultado.prediccion2 || 0;

        const historialLabels = periodos.map(p => p.fecha);
        const historial = periodos.map(p => p.totalVendido);
        
        function setGranularidad(valor) {
            document.getElementById('granularidad').value = valor;
            document.getElementById('filtroForm').submit();
        }
        
        const labels = [...historialLabels, "Predicci贸n +1 Periodo", "Predicci贸n +2 Periodos"]; 
        const dataPoints = [...historial, pred1, pred2];
        const pointColors = [...Array(historial.length).fill('rgba(54, 162, 235, 1)'),'rgba(255, 99, 132, 1)','rgba(255, 99, 132, 1)'];
        
        new Chart(document.getElementById('ventasChart'), { 
            type: 'line', 
            data: { 
                labels: labels, 
                datasets: [{ 
                    label: "Ventas ($)", 
                    data: dataPoints, 
                    borderColor: 'rgba(78, 115, 223, 1)', 
                    backgroundColor: 'rgba(78, 115, 223, 0.05)', 
                    fill: true, 
                    tension: 0.1, 
                    pointRadius: 5, 
                    pointBackgroundColor: pointColors 
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false }, 
                    title: { display: true, text: 'Tendencia de Ventas y Proyecci贸n Futura' }, 
                    tooltip: { 
                        callbacks: { 
                            label: function (context) { 
                                let label = context.dataset.label || ''; 
                                if (label) { label += ': '; } 
                                if (context.parsed.y !== null) { 
                                    label += new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(context.parsed.y); 
                                } 
                                return label; 
                            } 
                        } 
                    } 
                }, 
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        ticks: { 
                            callback: function(value) { return '$' + value.toLocaleString('es-CO'); } 
                        } 
                    } 
                } 
            } 
        });
        /*]]>*/
    </script>
</div>

</body>
</html>