<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layouts/admin-layout :: admin-layout(pageTitle=${pageTitle}, content=~{::content})}">
      <head>
    <title th:text="${pageTitle ?: 'Registrar Devolución'}">Registrar Devolución</title>
</head>
<body>
<th:block th:fragment="content">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800" th:text="${pageTitle}">Registrar Devolución</h1>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-undo-alt mr-2"></i>Datos de la Devolución
                    </h6>
                </div>
                <div class="card-body">
                    <form th:action="@{/devoluciones/guardar}" th:object="${devolucion}" method="post" id="formDevolucion">
                        <input type="hidden" th:field="*{ventaOriginalId}" />
                        <input type="hidden" th:field="*{numeroFacturaVentaOriginal}" />
                        <input type="hidden" th:field="*{clienteId}" />
                        <input type="hidden" th:field="*{nombreCliente}" />

                        <div th:if="${#fields.hasGlobalErrors() or (errorMessage != null and !#strings.isEmpty(errorMessage))}"
                             class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong th:if="${errorMessage != null and !#strings.isEmpty(errorMessage)}" th:text="${errorMessage}"></strong>
                            <ul th:if="${#fields.hasGlobalErrors()}" class="mb-0 pl-3">
                                <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
                            </ul>
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                         <div th:if="${#fields.hasErrors('detalles')}" class="alert alert-danger py-2" role="alert">
                            <ul class="mb-0 pl-3">
                                <li th:each="err : ${#fields.errors('detalles')}" th:text="${err}"></li>
                            </ul>
                         </div>

                        <div class="card bg-light mb-4">
                            <div class="card-body p-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Factura Original:</strong> <span th:text="*{numeroFacturaVentaOriginal}"></span></p>
                                        <p class="mb-0"><strong>Cliente:</strong> <span th:text="*{nombreCliente}"></span></p>
                                    </div>
                                    <div class="col-md-6 text-md-right">
                                        <p class="mb-0"><strong>Fecha Devolución:</strong> <span th:text="${#temporals.format(devolucion.fechaDevolucion, 'dd/MM/yyyy HH:mm')}"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <h6 class="mt-4 mb-3 font-weight-bold text-primary">Productos a Devolver:</h6>
                        <p class="text-muted small mb-3">Ingrese la cantidad a devolver para cada producto. El precio unitario es el de la venta original.</p>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Cant. Comprada</th>
                                        <th class="text-center" style="width: 150px;">Cant. a Devolver</th>
                                        <th class="text-right">Precio Unit.</th>
                                        <th>Motivo (Opcional)</th>
                                    </tr>
                                </thead>
                                <tbody id="detallesDevolucionContainer">
                                    <th:block th:if="*{detalles != null and !detalles.isEmpty()}" th:each="detalle, iterStat : *{detalles}">
                                        <tr>
                                            <td>
                                                <input type="hidden" th:field="*{detalles[__${iterStat.index}__].productoId}" />
                                                <input type="hidden" th:field="*{detalles[__${iterStat.index}__].nombreProducto}" />
                                                <input type="hidden" th:field="*{detalles[__${iterStat.index}__].precioUnitarioDevolucion}" />
                                                <span th:text="${detalle.nombreProducto}">Nombre del Producto</span>
                                            </td>
                                            <td class="text-center">
                                                <span th:text="${cantidadesOriginalesMap != null ? cantidadesOriginalesMap[detalle.productoId] : 'N/A'}">0</span>
                                            </td>
                                            <td>
                                                <input type="number" th:field="*{detalles[__${iterStat.index}__].cantidadDevuelta}"
                                                       th:id="'cantidadDevuelta-' + ${iterStat.index}"
                                                       class="form-control form-control-sm cantidad-devuelta-input text-center"
                                                       placeholder="0" min="0"
                                                       th:max="${cantidadesOriginalesMap != null ? (cantidadesOriginalesMap[detalle.productoId] ?: 0) : 0}"
                                                       th:errorclass="is-invalid"
                                                       oninput="validarCantidadDevuelta(this)" required/>
                                                <div th:if="${#fields.hasErrors('detalles[__${iterStat.index}__].cantidadDevuelta')}"
                                                     th:errors="*{detalles[__${iterStat.index}__].cantidadDevuelta}" class="invalid-feedback d-block"></div>
                                            </td>
                                            <td class="text-right">
                                                <span th:text="${detalle.precioUnitarioDevolucion != null ? #numbers.formatCurrency(detalle.precioUnitarioDevolucion) : #numbers.formatCurrency(0)}">$0.00</span>
                                            </td>
                                            <td>
                                                <input type="text" th:field="*{detalles[__${iterStat.index}__].motivoDevolucion}"
                                                       class="form-control form-control-sm" placeholder="Motivo" />
                                            </td>
                                        </tr>
                                    </th:block>
                                    <tr th:if="*{detalles == null or detalles.isEmpty()}">
                                        <td colspan="5" class="text-center text-muted py-3">No hay productos en la venta original o no se pudieron cargar.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="form-row mt-4">
                            <div class="form-group col-md-4">
                                <label for="estadoDevolucion" class="form-label">Estado Devolución:</label>
                                <select th:field="*{estadoDevolucion}" class="form-control" id="estadoDevolucion" required>
                                    <option value="PROCESADA">Procesada (Stock Actualizado)</option>
                                    <option value="PENDIENTE_REEMBOLSO">Pendiente de Reembolso</option>
                                    <option value="COMPLETADA">Completada (Reembolsada)</option>
                                </select>
                                <div th:if="${#fields.hasErrors('estadoDevolucion')}" th:errors="*{estadoDevolucion}" class="invalid-feedback d-block"></div>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="tipoReembolso" class="form-label">Tipo de Reembolso:</label>
                                <select th:field="*{tipoReembolso}" class="form-control" id="tipoReembolso">
                                    <option value="">N/A (Solo procesar stock)</option>
                                    <option value="EFECTIVO">Efectivo</option>
                                    <option value="NOTA_CREDITO">Nota de Crédito</option>
                                    <option value="CAMBIO_PRODUCTO">Cambio por otro producto</option>
                                    <option value="TRANSFERENCIA">Transferencia Bancaria</option>
                                </select>
                                <div th:if="${#fields.hasErrors('tipoReembolso')}" th:errors="*{tipoReembolso}" class="invalid-feedback d-block"></div>
                            </div>
                             <div class="form-group col-md-4">
                                <label for="montoReembolsado" class="form-label">Monto Reembolsado (si aplica):</label>
                                <div class="input-group">
                                     <div class="input-group-prepend">
                                        <span class="input-group-text">$</span>
                                    </div>
                                    <input type="number" th:field="*{montoReembolsado}" class="form-control" id="montoReembolsado" placeholder="0.00" step="0.01" />
                                </div>
                                <div th:if="${#fields.hasErrors('montoReembolsado')}" th:errors="*{montoReembolsado}" class="invalid-feedback d-block"></div>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label for="notas" class="form-label">Notas Adicionales:</label>
                            <textarea th:field="*{notas}" class="form-control" id="notas" rows="2" placeholder="Observaciones sobre la devolución..."></textarea>
                        </div>

                        <hr class="my-4">

                        <div class="d-flex justify-content-end">
                            <a th:href="@{/devoluciones/nueva(ventaId=*{ventaOriginalId})}" class="btn btn-outline-secondary mr-2">
                                <i class="fas fa-redo-alt mr-1"></i> Volver / Recargar
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg"> <i class="fas fa-check-circle mr-1"></i> Registrar Devolución
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
<script th:inline="javascript">
/*<![CDATA[*/
    function validarCantidadDevuelta(inputElement) {
        try {
            let cantidadDevuelta = parseInt(inputElement.value);
            if (isNaN(cantidadDevuelta) || cantidadDevuelta < 0) {
                cantidadDevuelta = 0;
                inputElement.value = 0; // Forzar a 0 si es inválido o negativo
            }

            let maxCantidadAttr = inputElement.getAttribute('max');
            if (maxCantidadAttr !== null) {
                let maxCantidad = parseInt(maxCantidadAttr);
                if (!isNaN(maxCantidad) && cantidadDevuelta > maxCantidad) {
                    inputElement.value = maxCantidad; // No permitir exceder el máximo
                }
            }
        } catch (e) {
            console.error("Error al validar cantidad: ", e);
            inputElement.value = 0; // Default a 0 en caso de error
        }
    }
    // Se puede añadir más JS aquí si se necesita recalcular totales de devolución dinámicamente
/*]]>*/
</script>
</th:block>
</body>
</html>
