<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:fragment="admin-layout(pageTitle, content)">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title th:text="${pageTitle ?: 'Kontrol+'}">Kontrol+</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/4.5.2/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/webjars/font-awesome/5.15.3/css/all.min.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <style>
        /* --- Variables (NUEVO TEMA LIMPIO) --- */
        :root {
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 90px;
            --color-primary: #4a43c9;
            --color-primary-dark: #4338CA;
            --color-primary-light: #F0F2FF;
            --color-bg: #F9FAFB;
            --color-surface: #FFFFFF;
            --text-dark: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --topbar-height: 70px;
        }

        /* --- Base --- */
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-bg); margin: 0; padding: 0; font-size: 0.9rem; color: var(--text-secondary); }
        h1, h2, h3, h4, h5, h6 { color: var(--text-dark); font-weight: 600; }

        /* --- Sidebar (Blanco) --- */
        .admin-sidebar { width: var(--sidebar-width); background-color: var(--color-surface); color: var(--text-secondary); position: fixed; top: 0; left: 0; height: 100%; padding-top: 0; overflow-y: auto; overflow-x: hidden; z-index: 1000; transition: width 0.3s ease; border-right: 1px solid var(--border-color); box-shadow: none; }
        .admin-sidebar .sidebar-header { height: var(--topbar-height); display: flex; align-items: center; justify-content: center; padding: 0 1rem; border-bottom: 1px solid var(--border-color); }
        .admin-sidebar .sidebar-header .logo-text { color: var(--text-dark); font-size: 1.6rem; font-weight: 700; text-decoration: none; letter-spacing: 1px; transition: color 0.2s, opacity 0.3s ease; white-space: nowrap; }
        .admin-sidebar .sidebar-header .logo-text:hover { text-decoration: none; color: var(--color-primary); }
        .admin-sidebar .nav { padding-top: 1rem; }
        .admin-sidebar .nav-item { margin-bottom: 1px; padding: 0 0.75rem; }

        /* --- Sidebar Links (Tema Nuevo) --- */
        .admin-sidebar .nav-link { color: var(--text-secondary); padding: 0.9rem 1.5rem; display: flex; align-items: center; font-size: 0.9rem; border-left: 4px solid transparent; position: relative; transition: all 0.25s ease-in-out; white-space: nowrap; font-weight: 500; border-radius: 0 8px 8px 0; margin-right: 1rem; }
        .admin-sidebar .nav-link i.nav-icon { margin-right: 12px; width: 20px; text-align: center; font-size: 1.05em; opacity: 0.8; transition: opacity 0.25s, transform 0.3s ease, color 0.25s; }
        .admin-sidebar .nav-link:hover { color: var(--color-primary); background-color: var(--color-primary-light); }
        .admin-sidebar .nav-link:hover i.nav-icon { opacity: 1; transform: scale(1.1) rotate(-5deg); }
        .admin-sidebar .nav-link.active { color: var(--color-primary); background-color: var(--color-primary-light); border-left-color: var(--color-primary); font-weight: 600; box-shadow: none; }
        .admin-sidebar .nav-link.active i.nav-icon { opacity: 1; color: var(--color-primary); transform: scale(1.1); }
        .nav-separator { margin: 1rem 1.5rem 0.5rem; border-top: 1px solid var(--border-color); transition: opacity 0.3s ease; }
        .submenu { display: none; list-style: none; padding: 0.5rem 0 0.5rem 2rem; background-color: transparent; }
        .submenu .nav-link { padding: 0.6rem 1rem; font-size: 0.85rem; border-left: none; margin-right: 0; border-radius: 8px; }
        .submenu .nav-link i.nav-icon { font-size: 0.9em; width: 18px; }
        .submenu .nav-link.active { font-weight: 600; color: var(--color-primary); background-color: var(--color-primary-light); border-left-color: transparent; }
        .nav-link.has-submenu::after { content: '\f105'; font-family: 'Font Awesome 5 Free'; font-weight: 900; position: absolute; right: 1.5rem; transition: transform 0.3s ease, opacity 0.3s ease; }
        .nav-link.has-submenu.open::after { transform: rotate(90deg); }
        .nav-item.active > .has-submenu { color: var(--text-dark); background-color: var(--color-bg); font-weight: 600; }

        /* --- Main Content and Topbar (Tema Limpio) --- */
        .admin-main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); padding-top: var(--topbar-height); transition: margin-left 0.3s ease, width 0.3s ease; display: flex; flex-direction: column; min-height: 100vh; }
        .admin-topbar { background-color: var(--color-surface); height: var(--topbar-height); position: fixed; top: 0; left: var(--sidebar-width); right: 0; display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; box-shadow: none; border-bottom: 1px solid var(--border-color); z-index: 999; transition: left 0.3s ease; }
        .admin-content-inner { flex-grow: 1; padding: 2rem; }
        .admin-footer { padding: 1.5rem 2rem; background-color: #ffffff; text-align: center; font-size: 0.85rem; color: #858796; margin-top: auto; border-top: 1px solid var(--border-color); }
        
        /* Bot칩n Hamburguesa */
        #sidebarToggle { background: none; border: none; font-size: 1.5rem; color: #858796; cursor: pointer; transition: color 0.2s; margin-left: -1rem; }
        #sidebarToggle:hover { color: var(--text-dark); }

        /* --- Estilos de Sidebar Colapsado --- */
        .sidebar-collapsed { width: var(--sidebar-width-collapsed); }
        .sidebar-collapsed .logo-text { opacity: 0; }
        .sidebar-collapsed .nav-link span,
        .sidebar-collapsed .nav-link.has-submenu::after,
        .sidebar-collapsed .nav-separator { opacity: 0; width: 0; overflow: hidden; }
        .sidebar-collapsed .nav-link { justify-content: center; padding: 0.9rem 1rem; margin-right: 0.75rem; }
        .sidebar-collapsed .nav-link i.nav-icon { margin-right: 0; }
        .sidebar-collapsed .submenu { display: none !important; }
        .main-content-collapsed { margin-left: var(--sidebar-width-collapsed); width: calc(100% - var(--sidebar-width-collapsed)); }
        .topbar-collapsed { left: var(--sidebar-width-collapsed); }

        /* --- User Info y Timer --- */
        .admin-topbar .user-info { display: flex; align-items: center; margin-left: auto; }
        .admin-topbar .user-info .nav-item { list-style: none; }
        .admin-topbar .user-info .dropdown-toggle { display: flex; align-items: center; text-decoration: none; }
        .dropdown-menu { border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        @keyframes growIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        #demo-timer-display { font-weight: 600; color: #e74a3b; align-self: center; margin-right: 1.5rem; white-space: nowrap; }

        /* ================================== */
        /* == NUEVO: ESTILOS AVATAR DE USUARIO == */
        /* ================================== */
        .user-name-text {
            margin-right: 0.75rem;
            display: none; /* Oculto en m칩vil */
        }
        @media (min-width: 992px) { /* visible en lg y m치s grande */
            .user-name-text {
                display: inline;
                color: var(--text-secondary);
                font-weight: 500;
            }
            .user-name-text:hover {
                color: var(--text-dark);
            }
        }
        .user-avatar-css {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--color-primary-light); /* Fondo azul claro */
            border: 2px solid var(--color-primary); /* Borde azul */
            color: var(--color-primary); /* Letra azul */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        .dropdown-toggle:hover .user-avatar-css {
             box-shadow: 0 0 10px rgba(74, 67, 201, 0.3); /* Sombra suave azul en hover */
        }
        /* ================================== */

        /* == ESTILOS GLOBALES (칔NICOS) == */
        /* Tarjetas */
        .card { border: 1px solid var(--border-color); box-shadow: none !important; border-radius: 12px; margin-bottom: 1.5rem; background-color: var(--color-surface); }
        .card-header { background-color: var(--color-surface); border-bottom: 1px solid var(--border-color); padding: 1rem 1.5rem; font-weight: 600; color: var(--text-dark); border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .card-body { padding: 1.5rem; }
        
        /* Botones */
        .btn { border-radius: 8px; font-weight: 500; padding: 0.6rem 1.2rem; transition: all 0.3s ease; box-shadow: none !important; }
        .btn-primary { background-color: var(--color-primary); border-color: var(--color-primary); }
        .btn-primary:hover { background-color: var(--color-primary-dark); border-color: var(--color-primary-dark); }
        .btn-warning { background-color: #F59E0B; border-color: #F59E0B; color: #fff; }
        .btn-warning:hover { background-color: #D97706; border-color: #D97706; color: #fff; }
        .btn-danger { background-color: #EF4444; border-color: #EF4444; }
        .btn-danger:hover { background-color: #DC2626; border-color: #DC2626; }
        .btn-info { background-color: #0EA5E9; border-color: #0EA5E9; }
        .btn-info:hover { background-color: #0284C7; border-color: #0284C7; }
        .btn-success { background-color: #10B981; border-color: #10B981; }
        .btn-success:hover { background-color: #059669; border-color: #059669; }
        .btn-outline-secondary { border-color: var(--border-color); color: var(--text-secondary); }
        .btn-outline-secondary:hover { background-color: var(--color-bg); color: var(--text-dark); }
        
        /* Formularios */
        .form-control { border-radius: 8px; border: 1px solid var(--border-color); padding: 0.75rem 1rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; background-color: #fff; }
        .form-control:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(74, 67, 201, 0.1); background-color: #fff; }
        
        /* Links */
        a { color: var(--color-primary); }
        a:hover { color: var(--color-primary-dark); }
        .dropdown-item.active, .dropdown-item:active { background-color: var(--color-primary); }
    </style>
</head>
<body>

<div class="admin-wrapper">
    <nav class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-header">
            <a th:href="@{/dashboard}" class="logo-text">Kontrol+</a>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link" th:href="@{/dashboard}" th:classappend="${(request.requestURI == '/dashboard' or request.requestURI == '/') ? 'active' : ''}"><i class="fas fa-home nav-icon"></i> <span>Dashboard</span></a></li>
            <li class="nav-item" sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_VENDEDOR', 'ROLE_DEMO')"><a class="nav-link" th:href="@{/pos}" th:classappend="${request.requestURI.startsWith('/pos') ? 'active' : ''}"><i class="fas fa-cash-register nav-icon"></i> <span>Terminal POS</span></a></li>
            <li class="nav-separator"></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/ventas}" th:classappend="${request.requestURI.startsWith('/ventas') ? 'active' : ''}"><i class="fas fa-shopping-cart nav-icon"></i> <span>Ventas</span></a></li>
            <li class="nav-item" sec:authorize="isAuthenticated()"><a class="nav-link" th:href="@{/cuentas-por-cobrar}" th:classappend="${request.requestURI.startsWith('/cuentas-por-cobrar') ? 'active' : ''}"><i class="fas fa-file-invoice-dollar nav-icon"></i> <span>Cuentas por Cobrar</span></a></li>
            <li class="nav-item" sec:authorize="isAuthenticated()"><a class="nav-link" th:href="@{/cuentas-por-pagar}" th:classappend="${request.requestURI.startsWith('/cuentas-por-pagar') ? 'active' : ''}"><i class="fas fa-receipt nav-icon"></i> <span>Cuentas por Pagar</span></a></li>
            <li class="nav-separator"></li>
            <li class="nav-item" sec:authorize="isAuthenticated()"><a class="nav-link" th:href="@{/compras}" th:classappend="${request.requestURI.startsWith('/compras') ? 'active' : ''}"><i class="fas fa-dolly nav-icon"></i> <span>Compras</span></a></li>
            <li class="nav-item menu-gestion-stock" sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_DEMO')">
                <a href="#" class="nav-link has-submenu"><i class="fas fa-box-open nav-icon"></i> <span>Gesti칩n de Stock</span></a>
                <ul class="submenu">
                    <li class="nav-item"><a class="nav-link" th:href="@{/productos}" th:classappend="${request.requestURI.startsWith('/productos') ? 'active' : ''}"><i class="fas fa-tag nav-icon"></i> <span>Productos</span></a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/inventario}" th:classappend="${request.requestURI.startsWith('/inventario') ? 'active' : ''}"><i class="fas fa-boxes nav-icon"></i> <span>Inventario</span></a></li>
                </ul>
            </li>
            <li class="nav-item" sec:authorize="isAuthenticated()"><a class="nav-link" th:href="@{/clientes}" th:classappend="${request.requestURI.startsWith('/clientes') ? 'active' : ''}"><i class="fas fa-address-book nav-icon"></i> <span>Clientes</span></a></li>
            <li class="nav-item" sec:authorize="isAuthenticated()"><a class="nav-link" th:href="@{/proveedores}" th:classappend="${request.requestURI.startsWith('/proveedores') ? 'active' : ''}"><i class="fas fa-truck-loading nav-icon"></i> <span>Proveedores</span></a></li>
            <li class="nav-item" sec:authorize="isAuthenticated()"><a class="nav-link" th:href="@{/devoluciones}" th:classappend="${request.requestURI.startsWith('/devoluciones') ? 'active' : ''}"><i class="fas fa-undo-alt nav-icon"></i> <span>Devoluciones</span></a></li>
            <li class="nav-separator"></li>
            <li class="nav-item menu-reportes" sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_DEMO')">
                <a href="#" class="nav-link has-submenu"><i class="fas fa-chart-pie nav-icon"></i> <span>An치lisis y Reportes</span></a>
                <ul class="submenu">
                    <li class="nav-item"> <a class="nav-link" th:href="@{/reportes}" th:classappend="${request.requestURI.startsWith('/reportes') ? 'active' : ''}"> <i class="fas fa-chart-bar nav-icon"></i> <span>Reportes</span> </a> </li>
                    <li class="nav-item"> <a class="nav-link" th:href="@{/prediccion}" th:classappend="${request.requestURI == '/prediccion' ? 'active' : ''}"> <i class="fas fa-chart-line nav-icon"></i> <span>Predicci칩n Ventas</span> </a> </li>
                    <!-- ============================================ -->
                    <!-- ==     L칈NEAS ELIMINADAS     == -->
                    <!-- ============================================ -->
                </ul>
            </li>
            <li class="nav-separator"></li>
            <li class="nav-item" sec:authorize="hasRole('ROLE_ADMIN')"><a class="nav-link" th:href="@{/admin/usuarios}" th:classappend="${request.requestURI.startsWith('/admin/usuarios') ? 'active' : ''}"><i class="fas fa-users-cog nav-icon"></i> <span>Usuarios</span></a></li>
            <li class="nav-item" sec:authorize="hasRole('ROLE_ADMIN')"><a class="nav-link" th:href="@{/configuraciones}" th:classappend="${request.requestURI.startsWith('/configuraciones') ? 'active' : ''}"><i class="fas fa-cogs nav-icon"></i> <span>Configuraciones</span></a></li>
        </ul>
    </nav>

    <div class="admin-main-content" id="mainContent">
        <nav class="admin-topbar" id="adminTopbar">
            
            <button id="sidebarToggle" class="btn btn-link d-md-block">
                <i class="fa fa-bars"></i>
            </button>

             <div id="demo-timer-display" style="display: none;">
                 <i class="fas fa-stopwatch mr-1"></i> Demo termina en: <span id="demo-timer-countdown">--:--:--</span>
             </div>

            <ul class="navbar-nav user-info">
                <li class="nav-item dropdown no-arrow">
                    <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="mr-2 d-none d-lg-inline text-gray-600 small" th:text="${#locale.country == 'CO'} ? 'Espa침ol (COP)' : 'English (USD)'"></span>
                        <i class="fas fa-globe"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="languageDropdown">
                        <a class="dropdown-item" th:href="@{''(lang='es-CO')}">游뻟릖 Espa침ol (COP)</a>
                        <a class="dropdown-item" th:href="@{''(lang='en-US')}">游쥟릖 English (USD)</a>
                    </div>
                </li>

                <div class="topbar-divider d-none d-sm-block" style="width: 0; border-right: 1px solid #e3e6f0; height: 40px; margin: auto 1rem;"></div>

                <li class="nav-item dropdown no-arrow">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdownAdminLayout" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="user-name-text" sec:authorize="isAuthenticated()" th:text="'Hi, ' + ${adminUsername ?: #authentication.name}"></span>
                        
                        <div class="user-avatar-css">
                            <span sec:authorize="isAuthenticated()" th:text="${#strings.substring(#authentication.name, 0, 1).toUpperCase()}">A</span>
                            <span sec:authorize="!isAuthenticated()">?</span>
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdownAdminLayout">
                        <a class="dropdown-item" href="#"><i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i> <span th:text="#{topbar.perfil}"></span></a>
                        <a class="dropdown-item" th:href="@{/configuraciones}"><i class="fas fa-cogs fa-sm fa-fw mr-2 text-gray-400"></i> <span th:text="#{topbar.configuracion}"></span></a>
                        <div class="dropdown-divider"></div>
                        <form th:action="@{/logout}" method="post" class="d-block">
                            <button type="submit" class="dropdown-item" style="border:none; background:none; cursor:pointer; width:100%; text-align:left;">
                                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i> <span th:text="#{topbar.cerrar_sesion}"></span>
                            </button>
                        </form>
                    </div>
                </li>
                </ul>
        </nav>

        <div class="admin-content-inner">
            <th:block th:replace="${content}"></th:block>
        </div>

        <footer class="admin-footer">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>Copyright &copy; Tu Sistema de Ventas <span th:text="${#dates.year(#dates.createNow())}"></span></span>
                </div>
            </div>
        </footer>
    </div>
</div>

<script th:src="@{/webjars/jquery/3.5.1/jquery.min.js}"></script>
<script th:src="@{/webjars/popper.js/1.16.0/umd/popper.min.js}"></script>
<script th:src="@{/webjars/bootstrap/4.5.2/js/bootstrap.min.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ... (Tu script de Toastr/WebSockets) ...
    });
</script>

<script>
$(document).ready(function() {
    // --- C칍DIGO PARA ABRIR Y CERRAR SUBMEN칔S ---
    $('.admin-sidebar .nav-link.has-submenu').on('click', function(e) {
        e.preventDefault(); 
        var $submenu = $(this).next('.submenu');
        $('.admin-sidebar .submenu').not($submenu).slideUp();
        $('.admin-sidebar .nav-link.has-submenu').not(this).removeClass('open');
        $submenu.slideToggle();
        $(this).toggleClass('open');
    });

    var $activeSublink = $('.admin-sidebar .submenu .nav-link.active');
    if ($activeSublink.length > 0) {
        var $parentMenu = $activeSublink.closest('.submenu').prev('.nav-link.has-submenu');
        $parentMenu.addClass('open'); 
        $parentMenu.next('.submenu').show(); 
    }
});
</script>

<script th:inline="javascript">
/*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        // ... (Tu script de Temporizador Demo) ...
    });
/*]]>*/
</script>

<script>
$(document).ready(function() {
    $('#sidebarToggle').on('click', function() {
        // ... (Tu script para colapsar men칰) ...
    });
});
</script>

<th:block layout:fragment="page-scripts"></th:block>

</body>
</html>